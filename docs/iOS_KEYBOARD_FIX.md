# Исправление проблемы с клавиатурой на iOS

## Проблема
На iOS устройствах клавиатура не закрывается автоматически при тапе вне поля ввода, в отличие от Android устройств. Это создает неудобство для пользователей.

## Решение

### 1. JavaScript функциональность (`docs/js/ui.js`)

Добавлена функция `installIOSKeyboardClose()`, которая:

- **Определяет iOS устройства** через Telegram WebApp API (`tg.platform === 'ios'`) и fallback методы
- **Закрывает клавиатуру** при тапе вне поля ввода через `touchend`, `touchstart` и `click` события
- **Обрабатывает нажатия кнопок** - клавиатура закрывается при нажатии на любую кнопку
- **Поддерживает клавиши** - Escape и Enter закрывают клавиатуру (Enter только для INPUT, не TEXTAREA)
- **Предоставляет API** - функция `window.dismissIOSKeyboard()` для программного закрытия
- **Использует правильные селекторы** - `closest('INPUT')` и `closest('TEXTAREA')` с заглавными буквами

### 2. CSS улучшения (`docs/css/style.css`)

Добавлены стили для улучшения UX на iOS:

- **Предотвращение зума** - минимальный размер шрифта 16px для полей ввода
- **Визуальная обратная связь** - анимация при тапе на поля ввода
- **Улучшенные стили** - убираем стандартные стили iOS для полей
- **Мобильная оптимизация** - увеличенная область тапа (44px минимум)

### 3. HTML мета-теги

Мета-тег viewport уже настроен правильно:
```html
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
```

## Как это работает

1. **Автоматическое закрытие**: При тапе в любом месте экрана вне поля ввода клавиатура автоматически закрывается
2. **Закрытие по кнопкам**: Нажатие на любую кнопку, ссылку или интерактивный элемент закрывает клавиатуру
3. **Закрытие по клавишам**: 
   - `Escape` - всегда закрывает клавиатуру
   - `Enter` - закрывает клавиатуру для однострочных полей ввода
4. **Программное закрытие**: Можно вызвать `window.dismissIOSKeyboard()` из любого места в коде

## Совместимость

- ✅ iOS Safari (iPhone, iPad)
- ✅ iOS WebView (в приложениях)
- ✅ Android (не влияет на существующее поведение)
- ✅ Desktop браузеры (не влияет)

## Тестирование

Для тестирования на iOS устройстве:
1. Откройте приложение в Safari
2. Нажмите на любое поле ввода
3. Попробуйте тапнуть вне поля - клавиатура должна закрыться
4. Попробуйте нажать на кнопку - клавиатура должна закрыться
5. Попробуйте нажать Escape или Enter - клавиатура должна закрыться

## Дополнительные возможности

Если нужно программно закрыть клавиатуру из JavaScript:

```javascript
// Закрыть клавиатуру программно
if (window.dismissIOSKeyboard) {
  window.dismissIOSKeyboard();
}
```

## Исправления (v2)

### Проблемы в первой версии
1. **Неправильные селекторы** - использовались строчные `'input'` вместо заглавных `'INPUT'`
2. **Игнорирование Telegram API** - не использовался `tg.platform === 'ios'`
3. **Неправильная проверка типа** - `activeElement.type !== 'textarea'` некорректна
4. **Passive события** - могли блокировать корректную работу

### Что исправлено
- ✅ Используется Telegram WebApp API для определения iOS
- ✅ Правильные селекторы `closest('INPUT')` и `closest('TEXTAREA')`
- ✅ Добавлен обработчик `touchend` (более надёжен на iOS)
- ✅ Исправлена проверка типа элемента для клавиши Enter
- ✅ Убрано `passive: true` с основного обработчика touchstart
- ✅ Добавлена задержка 10ms для корректной работы touchend
